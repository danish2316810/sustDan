const { join } = require('path')
const cds = require('../../../cds')
const { exists, mkdirp, path } = cds.utils
const { URLS, OPTIONS: { NODEJS, JAVA }, COMMAND_ADD } = require('../../constants')
const term = require('../../../util/term')
const { copyFiles } = require('../../util/template')
const LOG = console

module.exports = class NodejsTemplate extends require('../templateBase') {

    static hasFacet() {
        return !exists('pom.xml') || cds.cli.options?.add?.has(NODEJS)
    }

    async canRun() {
        if (cds.cli.command === COMMAND_ADD) {
            throw `You can't change the runtime of an existing project.`
        }
        if (cds.cli.options.add?.has(JAVA)) {
            throw `Only one runtime per project is supported. Specify either ${term.bold(JAVA)} or ${term.bold(NODEJS)}.`
        }
        return true
    }

    async run() {
        const { db, srv, app } = (await this.getEnv()).folders
        await copyFiles(join(__dirname, 'files'), cds.root, { projectName: path.basename(cds.root) }, cds.cli.options.force)
        await Promise.all([db, srv, app].map(p => mkdirp(p)))
    }

    async finalize() {
        LOG.info(`Find samples on ${term.link(URLS.SAMPLES)}`)
        LOG.info(`Learn about next steps at ${term.link(URLS.CAPIRE)}`)
    }
}
